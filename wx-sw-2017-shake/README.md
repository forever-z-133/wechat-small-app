# 2017上海购物节 - 全城摇一摇
---

2017年上海购物节开幕式上，进行一次全城摇一摇的抽奖活动。以地跌游全城为主题，最终目的地为开幕式场地“环球港”。

最初选用小程序而非 H5，主要是想借助微信的服务器来分摊并发请求的压力，打开一次后即有缓存，也不会因为 .html 请求不到而一直白屏。最终效果十分满意。

但自己犯了些错误，错判了系统错误的状态码，在我司接口服务器超负荷期间显示的是活动未开始，造成了一定的麻烦。

再者小程序的性能其实并没有它吹嘘的那么好，canvas 绘制基本只能有 20fps，否则会出现白屏；或者你自己试一下，for 万次，每次都 setData 显示会超乎寻常的卡，耗时比 HTML 绘制多数十倍，所以哪怕写个 loading 进度条都不敢多 setData 几次。总的来说，webview 和 js 分离确实提升了 webview 的流畅感，但也加大了两者的沟通成本。往后的项目需要多多注意。

其中可以说一下的事情有：

* 图片预加载，选 `<image bindload>` 还是 downloadFile 两者都是不错的选择，本案选择了后者
* canvas 操作，遇到了比较多的坑，可见 [我的总结](https://github.com/foreverZ133/blogs/issues/1)
* 动画算法，本案中为序列帧绘制，多组图片对应火车不同速度所需的组图，摇得快火车就跑得快。且为小程序的性能问题进行了许多实验，最终只得承认 js 与 webview 的沟通成本超高的。
* 抽奖逻辑，本案为预览版，去掉了这方面的代码。但实际项目中因牵扯到 6 个界面的显示隐藏，实在是麻烦。
* 临时模板消息提醒，为小程序新出的功能，需要 `<form bindsubmit>` 返回的 formid 以及 wx.login 和 wx.getUserInfo 的一些信息，官方文档有些地方写得不很明确，也爬过一会坑，需要后端同志的配合